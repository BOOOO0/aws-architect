# AWS Korea 실강

<details><summary>1일차</summary>

<div markdown="1">

## AWS 사용 이점은?

엔터프라이즈급 기업에서 온 프레미스로 서버를 추가 구축하면 수개월이 걸린다.

이 과정을 분 단위로 단축시킬 수 있다.

이후 추가 구축한 리소스가 필요하지 않을 때의 처리도 용이하다.

보안을 외주로 맡길 수 있다.

## AWS Global Infra는 어떻게 이루어져 있나

가용 영역은 데이터 센터의 묶음 최소 3개의 데이터 센터

리전은 가용 영역의 묶음 가용 영역은 a~d 까지 존재할 수 있음

리전 내의 데이터 센터는 내결함성을 갖추고 있으며 서로 거리를 두고 프라이빗 링크로 연결되어 있다.

이유는 고가용성을 달성하기 위해서 자연재해, 정치적 문제 등에 의해 전체 리전이 사용불가 상태가 되는 것을 방지

**_ 상파울루 리전의 경우 자체 발전기 사용해서 데이터센터를 유지한다. 전력 비용 측면에서도 AWS 사용이 이점이 있다. _**

## Local Zone & 엣지 로케이션

리전으로부터 너무 먼 경우 리전과 고속 케이블로 연결된 별도의 센터인 로컬존에 연결할 수 있다.

짧은 지연 시간을 얻지만 모든 서비스를 사용할 수는 없다.

엣지 로케이션 각 주요 도시에서 운영되며 Route 53, CloudFront 같은 서비스를 지원

CDN을 가능케한다.

엣지 로케이션에 캐시 데이터를 저장해서 더 빠르게 접근할 수 있도록 한다.

Local Zone은 EC2, RDS 등 리소스를 더 빠르게 접근하기 위해 사용

엣지 로케이션은 데이터 캐싱, 더 빠른 콘텐츠

Well Architected Framework에서 구축한 아키텍처를 자가점검할 수 있다.

AWS는 REST API를 통해 사용자에게 AWS 콘솔, AWS CLI, AWS SDK를 통한 리소스 생성, 관리를 가능하게 한다.

API 기반의 퍼블릭 클라우드

3개의 가용 영역에 복사되어서 올라간다 s3에 이미지 올리면

`aws s3 mb [버킷명]`

`aws s3 cp [From path] [To Path]`

`aws s3 ls` - 버킷 들의 리스트

`aws s3 ls [버킷명]` - 버킷 내 파일들의 리스트

## 계정 보안

- 인가된 사용자만 접근할 수 있도록 계정을 생성하고 권한을 부여

- API 요청이 들어오면 인증 -> 인가를 거친다. 그 후 리소스에 대한 요청을 처리하고 응답을 보낸다.

- 인증은 ID/PASSWD, 인가는 권한의 확인으로 두 과정 모두 IAM이 수행한다.

- root 계정 미사용은 AWS측 모범 사례가 맞음

- 정책은 권한을 담은 JSON 형식의 스크립트

- 그 정책을 사용자에게 적용

- 혹은 사용자 그룹에 적용한 후 그룹에 사람을 추가해서 적용되도록 하는 것이 조금 더 나은 선택

- 한 사용자가 여러 그룹에 속해서 많은 권한을 가질 수도 있다.

- 역할(Role)은 정책이 부여된 리소스로 사용 가능한 사용자를 기록해두고 Role이 적용된 사용자는 그 Role의 정책을 가진다.

- 그 후 Role과의 연결을 해제하면 본래 부여받은 정책을 다시 적용받는다.

- 역할을 수임한다. assuming a role

- 보안의 주체는 어떤 작업을 수행할 수 있는 모든 대상

- 서비스가 서비스에 명령을 내릴 경우 EC2에서 S3에 AWS CLI로 접근하는 경우 EC2가 S3에 명령을 내리는 것이므로 EC2는 보안의 주체

- 그 외 계정 등

- AWS ACCESS KEY , AWS SECRET ACCESS KEY - ACCESS KEY는 Public 키 처럼 공개되어도 괜찮다. 복호화 키이자 Private Key 역할을 하는 키는 SECRET ACCESS KEY

- KEY는 aws cli 디렉토리 내 credentials_allowed에 평문으로 저장되어 있기 때문에 노트북 분실 시 Deactivate 해야 한다.

- 정책은 커스텀이던 AWS 제공 정책이던 동등하다.

- 개인을 위한 역할을 생성해서 그 역할을 적용시키는 것이 가장 안전한 방법이긴 하다.

- 이유는 그룹도 잘못 지정해서 권한없는 사용자가 Admin 그룹의 권한을 얻게 되는 경우 위험할 수도 있으니까

- IAM 역할 동작 방식은 API 요청을 보내면 AWS STS가 토큰 생성해서 임시 권한 부여

- 정책은 권한의 부여 뿐만 아니라 최대 권한 설정해서 이후 권한 부여에 대한 경계를 설정할 수도 있다.

- 정책은 주로 권한 부여의 목적으로 쓰이고 위 경계 설정은 프로젝트 초기에 할 수도 있다.

- 자격 증명 기반 정책은 사용자, 그룹, 역할에 적용되고 리소스 기반 정책은 리소스에 적용된다.

- 사용자가 리소스 액세스를 시도하면 리소스 기반 정책을 확인한다? 이건 무슨 얘기인지 모르겠는데 \***\*\*\*\*\***\*\*\*\*\***\*\*\*\*\***

- 아래 JSON은 자격 증명 기반 정책

```JSON
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "ec2:Describe*",
                "ec2:GetConsole*"
            ],
            "Resource": "*"
        }
    ]
}
```

- Version은 정책의 버전

- Effect는 허용의 목적인지 거부의 목적인지?

- Action은 행위에 대한 것을 의미 S3 읽기 권한이란 그런 내용

- Resource는 위 내용들이 적용되는 대상 리소스

- 복수의 정책이 적용되는 경우 거부 Effect가 우선 적용된다.

- 허용의 경우 양 정책의 교집합에 해당하는 리소스 접근이 적용된다.

- 리소스 기반 정책의 경우 리소스를 arn으로 명시한다.

```JSON
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "AddPerm02",
            "Effect": "Allow",
            "Principal": "*",
            "Action": [
                "s3:ListBucket",
                "s3:GetObject"
            ],
            "Resource": [
                "arn:aws:s3:::00-22-architecting-on-aws",
                "arn:aws:s3:::00-22-architecting-on-aws/*"
            ]
        },
        {
            "Sid": "RemovePerm",
            "Effect": "Deny",
            "Principal": {
                "AWS": "arn:aws:iam::284141907816:user/deny"
            },
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::00-22-architecting-on-aws/public/*"
        }
    ]
}
```

- 리소스 기반 정책은 principal이라는 요소가 있는지 없는지로 구분하면 된다. (자격증 시험에 나온다면)

- 권한 중 EC2 ReadOnly는 인스턴스를 끄거나 삭제할 수 없고 정보만 읽을 수 있다.

- 다중 계정은

- Cloudtrail은 모든 API 요청에 대한 기록을 남긴다.

- **_ISMS 인증 관련 사항 중 Cloudtrail의 기록을 3년간 투명하게 보관해야 하는 사항이 있다._**

- AWS Organization을 사용해서 계정을 조직 단위(Organization Unit)로 그룹화해서 계층 구조를 생성한다.

- 계정과 계정은 서로 완전히 격리되어 있기 때문에 조직화하지 않으면 업무량이 많아지고 관리가 어렵다.

- 조직화 방법은 계층 구조이므로 상위 계층에서 허용된 사항이 있다면 하위 계층은 반드시 그 이하의 권한을 가지도록 하는 것이다.

- 관리 계정이 총괄하고 OU를 하위에 가진다.

- OU는 하위에 OU 혹은 계정을 가진다.

- 각 계정별로 결제되는 비용도 OU 단위로 결제가 가능하다.

- SCP vs IAM

- SCP는 권한을 제한하는 필터의 역할이다.

- 실질적 허용과 거부는 IAM이 한다.

- 뭔 개소리야 그래서 정확히 어떻게 동작한다는건데---------------- 이거 나중에 다시 보게되면 자세히--------------

- SCP -> IAM 순으로 보안 증명 필요

- https://docs.aws.amazon.com/ko_kr/organizations/latest/userguide/orgs_manage_policies_scps.html

## VPC

- 가상의 격리된 네트워크를 의미

- Regional하다.

### Public Subnet

- IGW를 사설 망을 외부 인터넷과 연결하는 가상의 라우터로 볼 수 있다.

- IGW에 대한 라우팅을 설정하고 인스턴스에 공인 IP를 부여하면 외부와의 통신을 공인 IP를 통해 할 수 있고 내부 망에서의 통신은 사설 IP로 할 수 있다.

### Routing Table

- VPC는 암시적 라우터가 존재해서 라우터를 직접 구축하지 않고 라우팅 테이블에 라우팅을 명시하는 것 만으로도 라우팅이 가능하다.

### Elastic IP Address

- 인스턴스에 붙였다 뗄 수 있는 고정된 공인 IP이다.

- 리전당, 계정당 5개로 제한된다.

- Quotar, Soft Quotar

- Soft Quotar여서 5개 제한을 문의를 통해 풀 수 있다.

### Elastic Network Interface

- 탄력적 네트워크 인터페이스는 같은 가용 영역 내에서 리소스에 붙였다 떼면서 사용할 수 있는 가상의 네트워크 인터페이스이다.

- 고정된 사설 IP, EIP, MAC 주소를 가지고 있다.

### NAT(Network Address Translation) Gateway

- 사설 IP 대역으로부터 외부 망으로의 Outbound 트래픽이 나갈 수 있도록 해주는 리소스이다.

- EIP를 요구한다.

- NAT Gateway를 통해 프라이빗 서브넷에서 인터넷을 사용할 수 있다.

### Network ACL

- 서브넷의 인바운드, 아웃바운드 트래픽을 제어하는 가상의 방화벽이다.

- 허용 규칙과 거부 규칙을 모두 명시한다.

- 비상태저장 방화벽이다.

- 한 트래픽 마다 들어갈때 나갈때 모두 확인한다.

- 서브넷에 배포된 모든 인스턴스에 적용된다.

### Security Group

- 인스턴스의 인바운드, 아웃바운드 트래픽을 제어하는 가상 방화벽이다.

- 허용 규칙만 명시한다.

- Source IP, Destination IP, 프로토콜, 포트를 명시해서 사용한다.

- 기본값은 모든 인바운드 트래픽을 막고 모든 아웃바운드 트래픽을 허용한다.

- 3-tier 라면

- WS 인바운드 80, 443 모든 IP에 허용

- WAS 인바운드 80 WS에 대해 허용

- DB 인바운드 3306 WAS에 대해 허용

- 이것을 Security Group Chain 이라고 한다.

- 트래픽의 접근 과정을 설명하면 IGW -> RTB -> NACL -> Subnet -> SG -> Instance

- 한 인스턴스에 복수의 SG가 적용될 수 있으며 종합적으로 평가해서 트래픽 허용 여부를 결정한다.

## 컴퓨팅

- EC2(2006) -> ECS(2014) -> Lambda(2014) -> Fargate(2017) -> Inferentia, Trainium, Graviton3(2021, 2022)

- Fargate는 서버리스 컨테이너화, 내 VPC 내에서 관리하는 서버가 없는게 서버리스인데 컨테이너를 내가 관리하지 않고 돌아가게 하는 것

- 그 뒤로는 맞춤 제작 프로세서라는데 뭔지 모름

- EKS도 쿠버네티스 기반 컴퓨팅 서비스

- CSP인 AWS의 컴퓨팅 리소스 생성 방식은 API 요청에 따라 하이퍼바이저에서 컴퓨팅 리소스(VM)를 생성하여 제공하는 것이다.

- 확장은 Scale-Out, 다시 축소는 Scale-In

### EC2

- 태그, 이름 - 사내에서 정해진 태그에 대한 네이밍 규칙을 정해서 생성한다.

- 예시 - 네이밍 룰에 따라 네임을 넣고 프로젝트를 구분해서 넣고 이 리소스가 배포 환경인지 테스트 환경인지 넣고 서비스 용도 프/백 넣고 가용 영역 구분해서 넣고 귀속 부서 구분해서 넣고

- Amazon Machine Image - OS를 포함한 리소스들을 가진 템플릿 이미지이다.

- 사전 구축된 AMI를 사용하거나 Marketplace에서 솔루션이 포함된 이미지를 사용하거나 Image Builder를 통해 커스텀 AMI를 생성한다.

- 하시코프 Packer가 이미지 빌더인듯?

#### 인스턴스 유형 이름 규칙

- c6g.xlarge

- c는 인스턴스 패밀리

- 6은 인스턴스 세대

- g는 추가 속성

- .뒤로는 인스턴스의 크기로 하드웨어 스펙의 규모 micro보다 xlarge가 더 많은 cpu, ram, ssd 가진 인스턴스

- amd는 추가 속성 위치에 a가 붙는다.

- graviton이 g인데 이게 AWS 자체 개발이라고 동일 성능일 경우 비용이 더 싸다고 합니다.

#### EC2 키 페어

- 최근엔 키 페어도 생성하지 않고 Session Manager로 접속하는 추세??

#### 테넌시

- 공유 테넌시가 기본값이며 하나의 하드웨어를 다른 사람들과 공유한다.

- 전용 인스턴스는 하드웨어를 격리해서 다른 사람과 공유하지 않고 사용한다.

- 전용 호스트는 하드웨어를 제어한다.

#### 배치 그룹

- 클러스터링을 통해 여러 인스턴스를 서로 인접하게 배치해서 고성능 컴퓨팅(HPC)을 가능하게 한다.

- 중요한 인스턴스라면 분산시켜서 안정성을 높인다.

- 파티션 분리는 가용 영역 내에서 논리적 구분을 하는 것이다.

#### User Data

- EC2가 생성될 때 최초로 실행될 스크립트를 작성할 수 있다.

#### 메타 데이터

- 인스턴스 내에서 `curl http://169.254.169.254/latest/` 명령줄을 통해 생성된 인스턴스의 메타 데이터를 출력할 수 있다.

- 공인 IP 주소 등을 출력할 수 있으며 `curl http://169.254.169.254/latest/meta-data/public-ipv4`

- 이 출력되는 메타 데이터를 자동화에 활용할 수 있다.

#### Elastic Block Storage

- 하나의 EC2는 반드시 최소 하나의 EBS를 가진다.

- EBS의 크기를 늘릴 수는 있지만 줄일 수는 없다.

- 작은 크기로 만들어서 복사하고 기존 것을 지워야 한다.

- EBS 볼륨 유형은 SSD 지원하는 gp2, gp3, io1, io2가 있고 가장 고성능은 io2이다. io2 Block Express가 가장 고성능

- IOPS가 뭔지 모르겠는데 그게 성능 나타낼 수 있는 지표인듯

- HDD 지원하는 st1, sc1

#### 인스턴스 스토어 볼륨

- 인스턴스에 바로 붙이는 데이터 스토어

- 속도가 빠르다.

- 스냅샷을 미지원해서 비영구적이고 휘발성이 있다.

- 캐싱의 용도로 사용할 수 있다.

#### EC2 구매 옵션

- 온디맨드는 초당 과금

- Savings Plans를 통해 1년 또는 3년 약정으로 사용도 가능

- 스팟 인스턴스는 온디맨드 대비 90% 할인 혜택을 받아 다른 사람의 여분 EC2를 사용하는 방법이다.

- 원 사용자가 반환을 요구할 경우 복구하는 자동화를 미리 구축해두어야 한다.

- 당근마켓이 비용 절감하는 방법으로 스팟 인스턴스를 많이 썼다고 한다.

- 쓰다가 뺏길 확률은 5% 정도라고 한다. 자동화 구축할 수 있다면 충분히 가능한 부분이다.

##### Savings Plan

- Compute Savings Plan - 리전 등 선택에 있어서 유연성 확보 + 66% 할인

- EC2 Savings Plan - 72% 할인 유연성 x

- 온디맨드 + Compute Savings plan + EC2 Savings Plan + 스팟 인스턴스를 잘 조합해서 비용 절감을 해야 한다.

### AWS Lambda

- 서버리스 컴퓨팅으로 Memory만 직접 스펙을 결정한다. Memory를 늘리면 CPU는 알아서 늘어난다.

- 서버리스는 실행될 때 마다 그리고 실행된 시간 만큼 비용이 발생하는 것이다.

- 24시간 내내 꽉찬 워크로드는 잘 없다. EC2 같은 리소스 쓸 때 평균 30% 정도 사용되면 잘 쓰는 것이다.

- 코드는 S3에 저장되고 필요한 경우에 호출된다.

- Lambda도 이중화 가능하다.

- API Gateway를 생성해서 생성한 Lambda의 API를 밖으로 내보낼 수 있다.

- 서버리스로 Lambda에 코드만 작성하고 API Gateway를 사용해서 API URL을 만들어내고 그 API URL을 어디서나 접근할 수 있도록 배포할 수 있다.

## 실습

- 여기에 아키텍처 넣고 설명

- 퍼블릭 서브넷에 퍼블릭 서버 생성, 프라이빗 서브넷에 프라이빗 서버 생성

- ![image](./img/스크린샷%202023-12-26%20오후%205.47.27.png)

- ICMP 프로토콜에 대한 허용 후 ping 트래픽 전달

- ![image](./img/스크린샷%202023-12-26%20오후%205.37.08.png)

- ![image](./img/스크린샷%202023-12-26%20오후%205.48.39.png)

- ![image](./img/스크린샷%202023-12-26%20오후%205.49.03.png)

- 인스턴스의 메타데이터 리스트 출력하고 그 중 원하는 데이터 출력하기

</div>

</details>
